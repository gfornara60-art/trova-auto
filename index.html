<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trova Auto</title>
  <meta name="description" content="Salva e ritrova il parcheggio dell'auto in un tap" />
  <!-- PWA basics -->
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üöó</text></svg>">
  <style>
    :root{
      --bg:#0b1220;--card:#141c2e;--muted:#8aa0b9;--text:#e6edf3;--accent:#49a6ff;--danger:#ff6666;--ok:#35d07f
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji';background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center}
    .app{width:min(750px,92vw);padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:1.35rem;margin:0;display:flex;gap:.5rem;align-items:center}
    .card{background:var(--card);border:1px solid #1f2a44;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:6px}
    input,textarea,select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #2a3a5e;background:#0f1727;color:var(--text)}
    textarea{min-height:60px;resize:vertical}
    .btn{appearance:none;border:none;border-radius:14px;padding:14px 16px;font-weight:600;background:#1a2846;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-accent{background:linear-gradient(180deg,#3fb3ff,#2986ff)}
    .btn-ghost{background:transparent;border:1px solid #2a3a5e}
    .btn-danger{background:linear-gradient(180deg,#ff8080,#ff4d4d)}
    .pill{padding:.35rem .65rem;border:1px solid #2a3a5e;border-radius:999px;color:var(--muted);font-size:.82rem}
    .muted{color:var(--muted)}
    .sep{height:1px;background:#243257;margin:10px 0 14px}
    .small{font-size:.86rem}
    .list{display:flex;flex-direction:column;gap:10px;margin:10px 0}
    .item{border:1px solid #23335a;background:#0f1727;border-radius:14px;padding:12px}
    .item .top{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .coords{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .tag{background:#1a2846;color:#cfe6ff;padding:.25rem .5rem;border-radius:999px;font-size:.78rem}
    a.link{color:#7bc5ff;text-decoration:none}
    .footer{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px}
    .accuracy{color:var(--muted);font-size:.8rem}
    .status{display:flex;align-items:center;gap:8px;margin:8px 0}
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:var(--ok)}
    .bad{background:var(--danger)}
    .warn{background:#ffb84d}
    .grid{display:grid;gap:10px}
    .help{font-size:.9rem;color:#b7c7db}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üöó Trova Auto <span class="pill" id="modePill">Solo dispositivo</span></h1>
      <button class="btn btn-ghost" id="installBtn" hidden>Aggiungi alla Home</button>
    </header>

    <div class="card grid" id="main">
      <div class="status" id="status"><span class="dot warn"></span><span>Pronto. Concedi l'accesso alla posizione per iniziare.</span></div>

      <div class="row">
        <div>
          <label>Chi sta parcheggiando?</label>
          <div class="row-3">
            <button class="btn" data-driver="Giorgio">Giorgio</button>
            <button class="btn" data-driver="Betta">Betta</button>
            <button class="btn" id="driverOther">Altro‚Ä¶</button>
          </div>
          <input id="driverInput" placeholder="Nome (opzionale)" />
        </div>
        <div>
          <label>Nota</label>
          <textarea id="note" placeholder="Es: vicino al bar, lato destro, varco ZTL‚Ä¶"></textarea>
        </div>
      </div>

      <div class="row">
        <button class="btn btn-accent" id="saveBtn">üíæ Salva posizione adesso</button>
        <button class="btn btn-ghost" id="openMapsBtn" disabled>üó∫Ô∏è Apri in Maps</button>
      </div>

      <div class="footer">
        <div class="small muted">Ultimo parcheggio: <span id="lastWhen">‚Äî</span></div>
        <div class="small muted">Coordinate: <span class="coords" id="lastCoords">‚Äî</span> <span class="accuracy" id="lastAcc"></span></div>
        <div class="small"><a class="link" href="#" id="shareLink">Condividi link posizione</a></div>
      </div>
    </div>

    <div class="card" id="historyCard">
      <h3 style="margin-top:0">Storico</h3>
      <div id="history" class="list"></div>
      <div class="sep"></div>
      <div class="help">
        Suggerimento: tocca "Aggiungi alla Home" per usarla come app su iOS/Android. I dati restano <b>solo sul dispositivo</b>. Se volete sincronizzare tra due telefoni, inserite una chiave Firebase qui sotto.
      </div>
      <details>
        <summary>‚öôÔ∏è Sincronizzazione (opzionale, richiede un vostro progetto Firebase)</summary>
        <div class="row">
          <textarea id="firebaseConfig" placeholder='Incolla qui l\'oggetto di configurazione Firebase (JSON)'></textarea>
          <div class="grid">
            <input id="sharedCarId" placeholder="ID auto condivisa (es. targa)" />
            <button class="btn" id="enableSyncBtn">Abilita sincronizzazione</button>
          </div>
        </div>
        <p class="muted small">Con la sync attiva, l'ultimo parcheggio viene scritto/letto su Firestore in <code>cars/&lt;ID&gt;/latest</code>. Costi: piano gratuito. Privacy: inviate solo coordinate e nota.</p>
      </details>
    </div>

    <p class="muted small" style="text-align:center;margin-top:10px">Made with ‚ô•Ô∏é. Nessun tracciamento. Funziona offline.</p>
  </div>

  <script>
    // ---- Utility ----
    const $ = sel => document.querySelector(sel);
    const fmtTime = ts => new Date(ts).toLocaleString('it-IT', { dateStyle:'medium', timeStyle:'short' });
    const store = {
      get(){ try { return JSON.parse(localStorage.getItem('parking:v1'))||{} } catch { return {} } },
      set(data){ localStorage.setItem('parking:v1', JSON.stringify(data)) }
    }

    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; $('#installBtn').hidden = false })
    $('#installBtn').addEventListener('click', async () => { if(!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt = null; $('#installBtn').hidden = true })

    // ---- State ----
    const state = {
      latest: null,
      history: [],
      sync: { enabled:false, carId:null, fb:null }
    }

    // ---- Load from storage ----
    function load(){
      const data = store.get();
      state.latest = data.latest || null;
      state.history = data.history || [];
      state.sync.enabled = data.sync?.enabled || false;
      state.sync.carId = data.sync?.carId || null;
      if(state.sync.enabled) $('#modePill').textContent = 'Condiviso (Firebase)';
      render();
    }

    // ---- Save to storage ----
    function persist(){
      store.set({ latest: state.latest, history: state.history.slice(0,100), sync:{ enabled: state.sync.enabled, carId: state.sync.carId } })
    }

    // ---- Geolocation ----
    async function getLocation(){
      return new Promise((resolve, reject) => {
        if(!('geolocation' in navigator)) return reject(new Error('Geolocalizzazione non supportata'))
        const opts = { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude, accuracy } = pos.coords
          resolve({ lat: latitude, lng: longitude, acc: accuracy, ts: Date.now() })
        }, err => reject(err), opts)
      })
    }

    // ---- UI handlers ----
    document.querySelectorAll('[data-driver]').forEach(btn=>btn.addEventListener('click', e=>{
      $('#driverInput').value = e.currentTarget.getAttribute('data-driver')
    }))
    $('#driverOther').addEventListener('click', ()=> $('#driverInput').focus())

    $('#saveBtn').addEventListener('click', async () => {
      setStatus('Rilevo posizione‚Ä¶', 'warn');
      $('#saveBtn').disabled = true;
      try{
        const loc = await getLocation();
        const driver = ($('#driverInput').value||'').trim() || null;
        const note = ($('#note').value||'').trim() || null;
        const item = { ...loc, driver, note };
        state.latest = item;
        state.history.unshift(item);
        persist();
        render();
        setStatus('Posizione salvata ‚úîÔ∏é', 'ok');
        // Firestore sync (if enabled)
        if(state.sync.enabled) await saveToCloud(item)
      }catch(err){
        console.error(err);
        setStatus('Errore: '+(err.message||err), 'bad')
      }finally{
        $('#saveBtn').disabled = false;
      }
    })

    $('#openMapsBtn').addEventListener('click', () => {
      if(!state.latest) return;
      const { lat, lng } = state.latest;
      const href = mapLink(lat, lng);
      window.location.href = href;
    })

    $('#shareLink').addEventListener('click', async (e) => {
      e.preventDefault();
      if(!state.latest) return;
      const { lat, lng, note } = state.latest;
      const url = mapLink(lat, lng);
      const text = `Posizione auto: ${lat.toFixed(5)}, ${lng.toFixed(5)}${note?` ‚Äî ${note}`:''}`
      try{
        if(navigator.share){ await navigator.share({ title:'Posizione auto', text, url }) }
        else{ await navigator.clipboard.writeText(url); alert('Link copiato negli appunti') }
      }catch{}
    })

    function mapLink(lat,lng){
      // Preferisce Apple Maps su iOS, Google Maps altrove
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      return isIOS ? `http://maps.apple.com/?ll=${lat},${lng}&q=Auto` : `https://www.google.com/maps?q=${lat},${lng}`
    }

    function setStatus(text, kind){
      const el = $('#status');
      el.querySelector('span:nth-child(2)').textContent = text;
      const dot = el.querySelector('.dot'); dot.className = 'dot '+(kind||'warn');
    }

    function render(){
      // last
      if(state.latest){
        $('#lastWhen').textContent = fmtTime(state.latest.ts)
        $('#lastCoords').textContent = `${state.latest.lat.toFixed(6)}, ${state.latest.lng.toFixed(6)}`
        $('#lastAcc').textContent = state.latest.acc?`(~${Math.round(state.latest.acc)} m)`:''
        $('#openMapsBtn').disabled = false
      } else {
        $('#lastWhen').textContent = '‚Äî'; $('#lastCoords').textContent = '‚Äî'; $('#lastAcc').textContent = '';
        $('#openMapsBtn').disabled = true
      }
      // history
      const wrap = $('#history');
      wrap.innerHTML = '';
      state.history.slice(0,20).forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="top">
            <div><span class="tag">${it.driver||'‚Äî'}</span></div>
            <div class="muted small">${fmtTime(it.ts)}</div>
          </div>
          <div class="coords">${it.lat.toFixed(6)}, ${it.lng.toFixed(6)} <span class="accuracy">${it.acc?`(~${Math.round(it.acc)} m)`:''}</span></div>
          ${it.note?`<div class="small" style="margin-top:6px">üìù ${escapeHtml(it.note)}</div>`:''}
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <a class="btn btn-ghost" href="${mapLink(it.lat,it.lng)}">Apri</a>
            <button class="btn btn-danger" data-del="${idx}">Elimina</button>
          </div>
        `
        wrap.appendChild(div)
      })
      wrap.querySelectorAll('[data-del]').forEach(btn=>btn.addEventListener('click', e=>{
        const i = Number(e.currentTarget.getAttribute('data-del'));
        state.history.splice(i,1);
        if(i===0) state.latest = state.history[0]||null;
        persist(); render();
      }))
    }

    function escapeHtml(str){
      return str.replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]))
    }

    // ---- Optional Firebase sync ----
    async function ensureFirebase(){
      if(state.sync.fb) return state.sync.fb;
      const cfgText = $('#firebaseConfig').value.trim();
      if(!cfgText) throw new Error('Config Firebase mancante');
      const cfg = JSON.parse(cfgText);
      // dinamicamente importa SDK modular (solo quando serve)
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
      const { getFirestore, doc, getDoc, setDoc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
      const app = initializeApp(cfg);
      const db = getFirestore(app);
      state.sync.fb = { db, doc, getDoc, setDoc, onSnapshot };
      return state.sync.fb;
    }

    async function saveToCloud(item){
      try{
        const { db, doc, setDoc } = await ensureFirebase();
        if(!state.sync.carId) throw new Error('ID auto condivisa mancante');
        const ref = doc(db, 'cars', state.sync.carId, 'data', 'latest');
        await setDoc(ref, item, { merge:true });
      }catch(e){ console.warn('Sync fallita', e) }
    }

    async function startCloudListener(){
      try{
        const { db, doc, onSnapshot } = await ensureFirebase();
        const ref = doc(db, 'cars', state.sync.carId, 'data', 'latest');
        onSnapshot(ref, snap => {
          const data = snap.data();
          if(data && (!state.latest || data.ts !== state.latest.ts)){
            state.latest = data; state.history.unshift(data); persist(); render(); setStatus('Aggiornato dalla cloud', 'ok')
          }
        })
      }catch(e){ console.warn('Listener cloud non avviato', e) }
    }

    $('#enableSyncBtn').addEventListener('click', async () => {
      try{
        state.sync.carId = ($('#sharedCarId').value||'').trim();
        if(!state.sync.carId) throw new Error('Inserisci un ID auto (es. targa)');
        await ensureFirebase();
        state.sync.enabled = true; persist(); $('#modePill').textContent = 'Condiviso (Firebase)';
        startCloudListener(); setStatus('Sincronizzazione attiva', 'ok');
      }catch(e){ alert(e.message||e) }
    })

    // ---- Boot ----
    load();
  </script>

  <script>
    // Service Worker per funzionamento offline su dominio (GitHub Pages, Netlify, ecc.)
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('sw.js').catch(()=>{})
      })
    }
  </script>
</body>
</html>
